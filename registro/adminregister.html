<script>
    document.addEventListener("DOMContentLoaded", function () {
        if (!sessionStorage.getItem("authenticated")) {
            // document.body.style.display = 'none';
            alert("No tienes permisos para acceder a esta p√°gina");
            // window.location.href = 'loggin.html';
        }
    });
</script>

<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRUD de Asistentes</title>.

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../assets/styles/style.css">
    <style>
        .markeo {
            background-image: url("../assets/img/textura.png");
            margin-top: 50px;
            padding-top: 30px;
            padding-bottom: 30px;
        }

        #attendeeForm {
            width: 80%;
            margin: auto;
            transition: opacity 0.3s ease-in-out;
            display: flex;
            justify-content: center;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        .act {
            width: 30px;
            margin-bottom: 5px;
            cursor: pointer;
            text-align: center;
        }

        .hidden {
            display: none;
        }

        .eye-icon {
            cursor: pointer;
            font-size: 1.5rem;
        }

        #toggleEye {
            cursor: pointer;
            display: inline-block;
            transition: transform 0.4s ease-in-out;
        }

        /* Animaci√≥n al pasar el mouse */
        #toggleEye:hover {
            transform: translateY(-20px) rotate(25deg) scale(1.2);
        }

        /* Efecto de sacudida al quitar el mouse */
        @keyframes shake {
            0% {
                transform: rotate(10deg);
            }

            25% {
                transform: rotate(-10deg);
            }

            50% {
                transform: rotate(10deg);
            }

            75% {
                transform: rotate(-10deg);
            }

            100% {
                transform: rotate(0deg);
            }
        }
    </style>
</head>

<body class="container mt-4">

    <header>
        <div class="content_header">
            <div class="bloque_hombre">
                <img class="logo" src="../assets/img/logoCmdc.png" alt="Logo de la conferencia" />>
            </div>
        </div>
    </header>

    <div class="markeo" style="overflow: scroll;">
        <h2 class="text-center">Registro de asistentes <span id="toggleEye" class="eye-icon">üêµ</span></h2>
        <p style="color: rgba(0, 0, 0, 0.5);">Ingresa los datos del asistente si no esta activo solo selecciona el
            mono (üêµ)</p>
        <div class="atte" id="atten">
            <form id="attendeeForm" class="d-flex flex-column gap-3 p-4 shadow-sm p-4">
                <input type="number" id="documento" class="form-control" placeholder="documento" required>
                <input type="text" id="nombre" class="form-control" placeholder="Nombre" required>
                <input type="text" id="apellido" class="form-control" placeholder="Apellido" required>
                <input type="email" id="email" class="form-control" placeholder="Email" required>
                <input type="number" id="celular" class="form-control" placeholder="Celular" required>
                <input type="text" id="boleta" class="form-control" placeholder="Rol Actual" required>
                <input type="number" min="1" max="1" value="1" id="ingresado" class="form-control"
                    placeholder="Ingresar" required>
                <input type="hidden" id="attendeeId" value="">

                <div class="d-flex gap-3">
                    <button type="submit" class="btn btn-primary">Registrar</button>
                    <button id="limpiar" type="submit" class="btn btn-success">Limpiar</button>
                </div>
            </form>
        </div>


        <h2 class="text-center mt-4">Lista de Asistentes</h2>
        <table class="table table-bordered table-striped mt-3">
            <thead class="table-dark">
                <tr>
                    <th>Act</th>
                    <th>Doc</th>
                    <th>Nombre</th>
                    <th>Apellido</th>
                    <th>Email</th>
                    <th>Celular</th>
                    <th>Ubicaci√≥n</th>
                    <th>Boleta</th>
                    <th>Ingresado</th>
                    <th>Act1</th>
                    <th>Act2</th>

                </tr>
            </thead>
            <tbody id="attendeesTable"></tbody>
        </table>
    </div>

    <script>
        const apiUrl = 'https://diosconsejero.com/apr/attendees';
        const encodedKey = btoa("tecnocuero2025api");
        console.log(encodedKey);
        document.getElementById('attendeeForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const id = document.getElementById('attendeeId').value;
            const isEdit = id !== "";

            const data = {
                nombre: document.getElementById('nombre').value,
                apellido: document.getElementById('apellido').value,
                email: document.getElementById('email').value,
                celular: document.getElementById('celular').value,
                documento: document.getElementById('documento').value,
                boleta: document.getElementById('boleta').value,
                ingresado: parseInt(document.getElementById('ingresado').value) || 0,
                rol: "presencial",
                act1: "0",
                act2: "0"
            };

            const url = isEdit ? `${apiUrl}/${id}` : apiUrl;
            const method = isEdit ? 'PUT' : 'POST';

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        "Authorization": `Basic ${encodedKey}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    throw new Error(isEdit ? 'Error al actualizar los datos' : 'Error al crear el asistente');
                }

                alert(isEdit ? '‚úÖ Asistente actualizado correctamente.' : '‚úÖ Asistente registrado correctamente.');

                // Redirigir despu√©s de √©xito
                window.location.reload(); // <- cambia esta ruta seg√∫n tu aplicaci√≥n

            } catch (error) {
                alert(`‚ùå ${error.message}`);
                console.error(error);
            }
        });

        async function loadAttendees() {
            const res = await fetch(apiUrl, {
                method: "GET",
                headers: {
                    "Authorization": `Basic ${encodedKey}`,
                    "Content-Type": "application/json"
                }
            });
            const attendees = await res.json();
            const tbody = document.getElementById('attendeesTable');
            tbody.innerHTML = '';
            attendees.forEach(att => {
                const row = `<tr>
                    <td id="${att.id}">
                        <div class="act" onclick="editAttendee(${att.id})">‚úçüèª</div>
                        <div class="act" onclick="deleteAttendee(${att.id})">üÜë</div>
                    </td>
                    <td>${att.documento}</td>
                    <td>${att.nombre}</td>
                    <td>${att.apellido}</td>
                    <td>${att.email}</td>
                    <td>${att.celular}</td>
                    <td>${att.rol}</td>
                    <td>${att.boleta}</td>
                    <td>${att.ingresado == 1 ? "SI" : "NO"}</td>
                    <td>${att.act1}</td>
                    <td>${att.act2}</td>
                    
                </tr>`;
                tbody.innerHTML += row;
            });
        }

        async function deleteAttendee(id) {
            const confirmDelete = confirm("¬øEst√° seguro de que desea eliminar este asistente?");
            if (confirmDelete) {
                await fetch(`${apiUrl}/${id}`, {
                    method: 'DELETE',
                    headers: {
                        "Authorization": `Basic ${encodedKey}`,
                        "Content-Type": "application/json"
                    }
                });
                loadAttendees();
            }
        }

        async function editAttendee(id) {
            try {
                const res = await fetch(`${apiUrl}/${id}`, {
                    method: "GET",
                    headers: {
                        "Authorization": `Basic ${encodedKey}`,
                        "Content-Type": "application/json"
                    }
                });

                if (!res.ok) throw new Error("No se pudo obtener el asistente");

                const att = await res.json();

                // Rellenar los campos del formulario
                document.getElementById('nombre').value = att.nombre;
                document.getElementById('apellido').value = att.apellido;
                document.getElementById('email').value = att.email;
                document.getElementById('celular').value = att.celular;
                document.getElementById('boleta').value = att.boleta;
                document.getElementById('documento').value = att.documento;
                document.getElementById('ingresado').value = att.ingresado;

                // Marcar que estamos editando
                document.getElementById('attendeeId').value = id;

            } catch (error) {
                alert(`‚ùå Error al cargar los datos: ${error.message}`);
                console.error(error);
            }
        }

        loadAttendees();

        document.getElementById("toggleEye").addEventListener("click", function () {
            const form = document.getElementById("atten");
            if (form.style.display === "none") {
                form.style.display = "block";
                this.textContent = "üôà"; // Mono con ojos tapados
            } else {
                form.style.display = "none";
                this.textContent = "üêµ"; // Mono normal
            }
        });

        document.getElementById("limpiar").addEventListener("click", function () {
            document.getElementById('attendeeForm').reset();
        });
    </script>
</body>

</html>