<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Lector QR con JS</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body>
  <div class="container-lector">
    <img src="./logotecno.png" alt="logo" width="350" />
    <h1>INGRESO USUARIO</h1>
    <p>
      Escanea el código QR para registrar el ingreso al evento.
    </p>
  </div>
  <div id="qr-reader"></div>

  <div id="modalIngreso" class="modal">
    <div class="modal-content">
      <h2 id="mensajeIngreso"></h2>
      <p><strong>Actividad 1:</strong> <span id="evento1"></span></p>
      <p><strong>Actividad 2:</strong> <span id="evento2"></span></p>
    </div>
  </div>


  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <script>

    const params = new URLSearchParams(window.location.search);
    const auth = params.get('authorization');

    function mostrarModal() {
      document.getElementById("modalIngreso").style.display = "block";
    }

    function cerrarModal() {
      document.getElementById("modalIngreso").style.display = "none";
    }


    function onScanSuccess(decodedText, decodedResult) {
      document.getElementById("codefin").innerText = decodedText;

      const final = decodedText.replace("010010-", "").trim();

      fetch(`https://diosconsejero.com/apr/materials/${final}`)
        .then(res => res.json())
        .then((res) => {
          // Mostrar modal
          mostrarModal();

          // Mostrar mensaje de backend
          const mensaje = res.message || "✔️ Ingreso registrado correctamente.";
          document.getElementById("mensajeIngreso").innerText = mensaje;

          // Mostrar eventos (si existen)
          const evento1 = getEventoById(res.attendee?.act1 || res.act1);
          const evento2 = getEventoById(res.attendee?.act2 || res.act2);

          if (evento1) {
            document.getElementById("evento1").innerText = `${evento1.hora} - ${evento1.evento}`;
          } else {
            document.getElementById("evento1").innerText = "Sin actividad registrada.";
          }

          if (evento2) {
            document.getElementById("evento2").innerText = `${evento2.hora} - ${evento2.evento}`;
          } else {
            document.getElementById("evento2").innerText = "Sin actividad registrada.";
          }

          // Cerrar modal después de 10 segundos
          setTimeout(() => {
            cerrarModal();
          }, 10000);
        })
        .catch((e) => {
          alert("❌ Error al registrar el ingreso");
          console.error(e);
          document.body.remove(); // cuidado con esto si no estás seguro
        });
    }

    if (auth == "approval") {
      const html5QrCode = new Html5Qrcode("qr-reader");
      html5QrCode.start(
        { facingMode: "environment" },
        {
          fps: 10,
          qrbox: 250
        },
        onScanSuccess
      ).catch(err => {
        console.error("Error al iniciar el escáner:", err);
      });
    } else {
      document.body.remove();
      alert("No autorizado para ingresar");
      throw new Error("No autorizado");
    }

  </script>
</body>

</html>